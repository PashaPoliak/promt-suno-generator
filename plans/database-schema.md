# Database Schema for Suno Prompt Generator

## Overview
This document outlines the database schema for the Suno Prompt Generator application. The schema is designed to store prompt templates, user data, generated prompts, and related information efficiently.

## Design Principles
- Normalize data to reduce redundancy
- Ensure referential integrity
- Optimize for common query patterns
- Support future scalability
- Use UUID primary keys for distributed systems

## Database Schema

### 1. Users Table
Store user information for authentication and personalization.

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(100) UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2. Categories Table
Organize prompt templates into categories.

```sql
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 3. Tags Table
Flexible tagging system for categorizing prompts.

```sql
CREATE TABLE tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    tag_type VARCHAR(50), -- 'genre', 'mood', 'style', 'instrument', 'voice'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 4. Prompt Templates Table
Store reusable prompt templates with various attributes.

```sql
CREATE TABLE prompt_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    genre VARCHAR(100),
    mood VARCHAR(100),
    style VARCHAR(100),
    instruments TEXT,
    voice_tags TEXT,
    lyrics_structure TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    category_id UUID REFERENCES categories(id),
    created_by UUID REFERENCES users(id)
);
```

### 5. Prompt Template Tags Junction Table
Many-to-many relationship between templates and tags.

```sql
CREATE TABLE prompt_template_tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID REFERENCES prompt_templates(id) ON DELETE CASCADE,
    tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(template_id, tag_id)
);
```

### 6. Generated Prompts Table
Store prompts generated by users.

```sql
CREATE TABLE generated_prompts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    template_id UUID REFERENCES prompt_templates(id),
    prompt_text TEXT NOT NULL,
    parameters JSONB, -- Store additional parameters as JSON
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_favorite BOOLEAN DEFAULT FALSE,
    generation_result JSONB -- Store Suno API response if needed
);
```

### 7. Favorite Prompts Table
Track user favorite prompts.

```sql
CREATE TABLE favorite_prompts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    prompt_id UUID REFERENCES generated_prompts(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, prompt_id)
);
```

## SQLAlchemy Models

### Base Model
```python
from sqlalchemy import Column, Integer, String, Text, Boolean, DateTime, ForeignKey, JSON
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.sql import func
import uuid

Base = declarative_base()
```

### User Model
```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    username = Column(String(100), unique=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
```

### Category Model
```python
class Category(Base):
    __tablename__ = "categories"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(100), nullable=False)
    description = Column(Text)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

### Tag Model
```python
class Tag(Base):
    __tablename__ = "tags"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(50), unique=True, nullable=False)
    description = Column(Text)
    tag_type = Column(String(50))  # 'genre', 'mood', 'style', 'instrument', 'voice'
```

### Prompt Template Model
```python
class PromptTemplate(Base):
    __tablename__ = "prompt_templates"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(255), nullable=False)
    description = Column(Text)
    genre = Column(String(10))
    mood = Column(String(100))
    style = Column(String(100))
    instruments = Column(Text)
    voice_tags = Column(Text)
    lyrics_structure = Column(Text)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
    is_active = Column(Boolean, default=True)
    category_id = Column(UUID(as_uuid=True), ForeignKey("categories.id"))
    created_by = Column(UUID(as_uuid=True), ForeignKey("users.id"))
```

### Prompt Template Tag Model
```python
class PromptTemplateTag(Base):
    __tablename__ = "prompt_template_tags"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    template_id = Column(UUID(as_uuid=True), ForeignKey("prompt_templates.id", ondelete="CASCADE"))
    tag_id = Column(UUID(as_uuid=True), ForeignKey("tags.id", ondelete="CASCADE"))
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

### Generated Prompt Model
```python
class GeneratedPrompt(Base):
    __tablename__ = "generated_prompts"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id"))
    template_id = Column(UUID(as_uuid=True), ForeignKey("prompt_templates.id"))
    prompt_text = Column(Text, nullable=False)
    parameters = Column(JSON)  # Store additional parameters as JSON
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    is_favorite = Column(Boolean, default=False)
    generation_result = Column(JSON)  # Store Suno API response if needed
```

### Favorite Prompt Model
```python
class FavoritePrompt(Base):
    __tablename__ = "favorite_prompts"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="CASCADE"))
    prompt_id = Column(UUID(as_uuid=True), ForeignKey("generated_prompts.id", ondelete="CASCADE"))
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

## Performance Optimizations

### Indexes
```sql
-- Performance indexes for common queries
CREATE INDEX idx_prompt_templates_genre ON prompt_templates(genre);
CREATE INDEX idx_prompt_templates_mood ON prompt_templates(mood);
CREATE INDEX idx_prompt_templates_style ON prompt_templates(style);
CREATE INDEX idx_generated_prompts_user ON generated_prompts(user_id);
CREATE INDEX idx_generated_prompts_template ON generated_prompts(template_id);
CREATE INDEX idx_prompt_template_tags_template ON prompt_template_tags(template_id);
CREATE INDEX idx_prompt_template_tags_tag ON prompt_template_tags(tag_id);
CREATE INDEX idx_generated_prompts_favorite ON generated_prompts(is_favorite);
```

## Key Design Decisions

1. **UUID Primary Keys**: Using UUIDs for all primary keys to support distributed systems and avoid ID conflicts.

2. **Flexible Parameters**: Using JSONB columns for storing flexible parameters that may vary between prompt types.

3. **Tag System**: Implementing a tag system to allow flexible categorization of prompts beyond the basic genre/mood/style.

4. **Template System**: Separating templates from generated prompts to allow for reusability and standardization.

5. **User Favorites**: Separate table for favorites to support complex relationships and queries.

6. **Indexes**: Strategic indexing on commonly queried fields for performance optimization.

## Migration Strategy

### Using Alembic for Database Migrations
```python
# alembic/versions/xxx_create_initial_schema.py
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

def upgrade():
    # Create tables in dependency order
    op.create_table('users',
        sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('username', sa.String(length=100), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('username')
    )
    
    # Additional table creation statements...
    
    # Create indexes
    op.create_index('idx_prompt_templates_genre', 'prompt_templates', ['genre'])
    # Additional index creation statements...

def downgrade():
    # Drop indexes
    op.drop_index('idx_prompt_templates_genre', table_name='prompt_templates')
    # Additional index drops...
    
    # Drop tables in reverse dependency order
    op.drop_table('favorite_prompts')
    op.drop_table('generated_prompts')
    # Additional table drops...
```

This schema provides a robust foundation for the Suno Prompt Generator application, supporting all required functionality while maintaining data integrity and performance.
